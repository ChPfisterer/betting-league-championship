name: Sync Tasks to GitHub Issues

# Global minimal permissions (can be overridden by job-level permissions)
permissions:
  contents: read

on:
  push:
    paths:
      - 'specs/001-multi-sport-betting/tasks.md'
    branches:
      - main
      - develop
  schedule:
    # Run every hour during business hours (UTC)
    - cron: '0 9-17 * * 1-5'

# Note: Manual execution via workflow_dispatch removed for security compliance
# Use schedule or push triggers instead

jobs:
  sync-tasks:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install
      
      - name: Setup GitHub CLI
        run: |
          # GitHub CLI is pre-installed on ubuntu-latest
          gh --version
      
      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      
      - name: Create milestones if they don't exist
        run: |
          # Create milestones for the project phases
          gh api repos/:owner/:repo/milestones --jq '.[].title' > existing_milestones.txt || echo "" > existing_milestones.txt
          
          for milestone in "Phase 1: Infrastructure Setup" "Phase 2: Test Development (TDD)" "Phase 3: Core Implementation" "Phase 4: Integration & Features" "Phase 5: Polish & Deployment"; do
            if ! grep -q "$milestone" existing_milestones.txt; then
              echo "Creating milestone: $milestone"
              gh api repos/:owner/:repo/milestones \
                --method POST \
                --field title="$milestone" \
                --field description="Auto-generated milestone for $milestone" \
                --field state="open" || echo "Failed to create milestone: $milestone"
            else
              echo "Milestone already exists: $milestone"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Sync tasks to issues
        run: |
          cd .github/scripts
          export GITHUB_REPOSITORY="${{ github.repository }}"
          node sync-tasks-to-issues.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_SYNC: ${{ inputs.force_sync }}
      
      - name: Use existing project
        id: get-project
        run: |
          # Use our existing project number 4 (Betting League Championship)
          PROJECT_ID="4"
          echo "âœ… Using existing project: Betting League Championship (ID: $PROJECT_ID)"
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add issues to project (simplified)
        if: steps.get-project.outputs.project_id != ''
        run: |
          # Add all task issues to project using simpler gh project commands
          echo "ğŸ“‹ Adding issues to project..."
          
          # Get all task issues and add them to project
          gh issue list --label "task" --limit 1000 --json number | jq -r '.[].number' | while read issue_number; do
            if [ -n "$issue_number" ]; then
              echo "Adding issue #$issue_number to project..."
              gh project item-add ${{ steps.get-project.outputs.project_id }} --owner ChPfisterer --url "https://github.com/ChPfisterer/betting-league-championship/issues/$issue_number" 2>/dev/null || echo "Issue #$issue_number might already be in project"
            fi
          done
          
          echo "âœ… Issue addition complete"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary comment
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get the tasks count
            const tasksContent = fs.readFileSync('specs/001-multi-sport-betting/tasks.md', 'utf8');
            const taskMatches = tasksContent.match(/- \[ \] T\d+/g) || [];
            const taskCount = taskMatches.length;
            
            const comment = `ğŸ¤– **GitHub Issues Sync Complete**
            
            ğŸ“‹ **Tasks processed**: ${taskCount}
            ğŸ“ **Issues created/updated**: Check the [Issues tab](https://github.com/${context.repo.owner}/${context.repo.repo}/issues?q=is%3Aissue+label%3Atask)
            ğŸ“Š **Project board**: [Multi-Sport Betting Platform](https://github.com/${context.repo.owner}/${context.repo.repo}/projects)
            
            ## Next Steps:
            1. ğŸ¯ Assign yourself to issues you want to work on
            2. ğŸŒ¿ Feature branches will be created automatically
            3. ğŸ“ Follow TDD methodology for each task
            4. ğŸ”„ Create PRs when tasks are complete
            
            ## TDD Workflow Reminder:
            - âœ… **RED**: Write failing tests first
            - âœ… **GREEN**: Implement minimal code to pass
            - âœ… **REFACTOR**: Improve code quality
            
            *Auto-generated by sync-tasks workflow*`;
            
            // Only create comment if this is a push to main/develop
            if (['main', 'develop'].includes(context.ref.replace('refs/heads/', ''))) {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: comment
              });
            }